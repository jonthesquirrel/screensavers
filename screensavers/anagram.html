<!DOCTYPE html>
<!-- Copyright (c) 2014 Jonathan Herman - MIT License -->
<!-- https://github.com/jdh11235/screensavers -->

<html lang="en" manifest="../manifest.appcache">
	<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

	<title>Anagram â€¢ screensaver</title>

<style>

	body {
		padding-top: 2.5em;

		font-family: sans-serif;
		background: #f9f9f9;
	}

	a:hover {
		color: skyblue;
	}

	.header {
		position: fixed;
		top: 0;
		padding: 0.25em;
		text-align: center;
		font-size: 1.25em;

		background: black;
		color: white;
		font-family: cursive;
	}

	.topmiddle {
		z-index: 2;
		left: 0;
		width: 100%;

		cursor: pointer;
	}

	.topleft {
		z-index: 3;
		left: 0;
		padding-left: 0.5em;
	}

	.topright {
		z-index: 4;
		right: 0;
		padding-right: 0.5em;
	}

	.middle {
		z-index: 100;
		position: fixed;
		top: 50%;
		text-align: center;
		left: 50%;

		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
	}

</style>
</head>
<body>

	<div class="header topleft">
		Number of words:
		<input type="number" id="prefs_words">
	</div>

	<div class="header topmiddle" onclick="location.reload();">
		Anagram
	</div>

	<a href="../" class="header topright">git.io/screensavers</a>

	<div id="splashscreen" class="middle">
		<input type="text" id="wordbox" placeholder="type a word" autofocus>
		<button id="activatebutton">Anagram</button>
	</div>

<script>
window.addEventListener('load', function () { 'use strict';

	var init = function () {
		prefs.init();
		$prefs_words.value = prefs.get('words');
	};

	//preferences

	window.prefs = {

		get: function (key) {
			return localStorage[key];
		},

		set: function (key, value) {
			if (prefs.check[key]) {
				value = prefs.check[key](value);
				localStorage[key] = value;
				return value;
			} else {
				return false;
			}
		},

		check: {

			capitalize: function (b) {
				//true or false
				return (typeof b === 'boolean') ? b : prefs.defaults.capitalize;
			},

			words: function (n) {
				//positive integer
				return ((n % 2 === 1 || n % 2 === 0) && n > 0) ? n : prefs.defaults.words;
			}

		},

		defaults: {

			capitalize: true,
			words: 1

		},

		init: function () {
			for (var key in prefs.defaults) {
				prefs.set(key, prefs.get(key));
			}
		}

	};

	//sugar

	var rgb = function (r, g, b) {
		return 'rgb(' + r + ', ' + g + ', ' + b + ')';
	};

	//string utils

	String.prototype.randomAnagram = function () {
		return this.split('').sort(function () {
			return 0.5 - Math.random();
		}).join('');
	};

	String.prototype.toTitleCase = function () {
		var str = this;
		var newStr = '';

		var words = str.split(' ');
		for (var i = 0; i < words.length; i++) {
			newStr += ' ' + words[i].slice(0, 1).toUpperCase() + words[i].slice(1).toLowerCase();
		}

		return newStr.trim();
	};

	//randomizers

	var randomInRange = function (min, max) {
		return Math.round(Math.random() * (max - min) + min);
	};

	var randomColor = function () {
		return rgb(randomInRange(0, 255), randomInRange(0, 255), randomInRange(0, 255));
	};

	//elements

	var $wordbox = document.getElementById('wordbox');
	var $activatebutton = document.getElementById('activatebutton');
	var $splashscreen = document.getElementById('splashscreen');
	var $prefs_words = document.getElementById('prefs_words');

	//placeholders

	var word;
	var last_scroll;

	//processors

	var processWord = function (word) {
		word = word.randomAnagram().trim();
		if (prefs.capitalize) {
			word = word.toTitleCase();
		}
		return word;
	};

	//animation

	var animate = function () {
		autoScroll();
		document.body.appendChild(wordContainerElement(processWord(word)));
	};

	var loopAnimate = function () {
		//respond instantly instead of initial delay
		animate();
		setInterval(animate, 100);
	};

	//DOM

	var wordContainerElement = function(word) {
		var elm = document.createElement('span');

		elm.style.padding = '0.5em';
		elm.style.color = randomColor();

		//adding a space fixes the layout issue (lines not wrapping)
		elm.innerText = ' ' + word;

		return elm;
	};

	//UI

	var removeSplash = function () {
		$splashscreen.parentNode.removeChild($splashscreen);
	};

	var autoScroll = function () {
		//if scrolled to bottom of page, auto scroll
		if (window.scrollY + window.innerHeight === document.body.scrollHeight) {
			last_scroll = true;
		} else if (last_scroll) {
			window.scrollTo(0, Infinity);
			last_scroll = false;
		}
	};

	//event handlers

	var activate = function () {
		if ($wordbox.value) {
			word = $wordbox.value;
			removeSplash();
			loopAnimate();
		}
	};

	$wordbox.addEventListener('keydown', function (event) {
		//the Enter key
		if (event.keyCode === 13) {
			activate();
		}
	});

	$activatebutton.addEventListener('click', activate);

	$prefs_words.addEventListener('input', function (event) {
		$prefs_words.value = prefs.set('words', $prefs_words.value);
		console.log(event);
	});

	//must be called last
	init();
});
</script>
</body>
</html>
