<!DOCTYPE html>
<!-- Copyright (c) 2014 Jonathan Herman - MIT License -->
<!-- https://github.com/jdh11235/screensavers -->

<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

	<title>Bouncy Squares - screensaver</title>

	<style>

		body {
			background: black;
			height: 100%;
			margin: 0;
			padding: 0;
			position: fixed;
			width: 100%;
		}

		.nav {
			box-shadow: inset 0 0 0 0.5em darkgray;
			color: darkgray;
			font-family: fantasy;
			padding: 1em;
			position: fixed;
			right: 0;
			top: 0;
			z-index: 3;
		}

		.fps {
			color: darkgrey;
			font-family: monospace;
			left: 0;
			padding: 0.5em;
			position: fixed;
			top: 0;
			z-index: 2;
		}

		.noselect {
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			-webkit-user-select: none;
		}

	</style>
</head>
<body class="noselect">
	<a href="http://git.io/screensavers" class="nav">git.io/screensavers</a>
	<!--TODO: add *click* message overlay that (maybe) dissapears on first click-->

	<span id="fps" class="fps">0 fps</span>

	<script>
		'use strict';

		//prevent touch scrolling
		document.ontouchmove = function (event) { event.preventDefault(); };

		/* begin animation */

		var $fps = document.getElementById('fps');

		function displayFps (fps) {
			$fps.innerHTML = Math.round(fps) + ' fps';
		}

		//diameter of square
		var square_size = 32;
		//pixels travelled per frame
		var square_speed = {
			min: 1,
			max: 10
		};

		function SquareElement (color) {
			var element = document.createElement('div');

			element.style.position = 'fixed';
			element.style.width = square_size + 'px';
			element.style.height = square_size + 'px';
			//FIXME: box-shadow not showing up when element is created
			element.style.boxShadow = 'inset 0 0 0 ' + (square_size / 4) + 'px ' + color;

			return element;
		}

		function randomInRange (min, max) {
			return Math.round(Math.random() * (max - min) + min);
		}

		function randomColor () {
			return '#' + randomInRange(0, 0xffffff).toString(16);
		}

		function maxX () {
			return window.innerWidth - square_size;
		}

		function maxY () {
			return window.innerHeight - square_size;
		}

		function randomX () {
			return randomInRange(0, maxX());
		}

		function randomY () {
			return randomInRange(0, maxY());
		}

		function plusOrMinus () {
			return (randomInRange(0, 1) === 1) ? '+' : '-';
		}

		var queue = 1;
		var elements = [];

		function moveElement (obj, index, arr) {
			//TODO: calculate and move obj.element (etc)
		}

		var previous_time = 0;

		function animate (time) {
			displayFps(1000 / (time - previous_time));
			previous_time = time;

			if (queue > 0) {
				var color = randomColor();
				var x = randomX();
				var y = randomY();
				var speed = randomInRange(square_speed.min, square_speed.max);

				var obj = {
					element: SquareElement(color),
					positionX: x,
					positionY: y,
					updateX: function () {
						this.element.style.left = this.positionX;
					},
					updateY: function () {
						this.element.style.top = this.positionY;
					},
					directionX: plusOrMinus(),
					directionY: plusOrMinus(),
					speed: speed
				};

				elements.push(obj);

				moveElement(obj);

				document.body.appendChild(element);

				queue--;
			}

			//animate all elements
			elements.forEach(moveElement);

			requestAnimationFrame(animate);
		}

//		requestAnimationFrame(animate);
		/* end animation */

		/* begin fasterclick */
		var element = document.body;

		var anticlick = 0;

		function spawnSquare () {
			queue++;
		}

		function handle_touchstart (event) {
			spawnSquare();

			anticlick++;
		}

		function handle_click (event) {
			if (anticlick > 0) {
				anticlick--;
			} else {
				spawnSquare();
			}
		}

		element.addEventListener('touchstart', handle_touchstart);
		element.addEventListener('click', handle_click);
		/* end fasterclick */
	</script>
</body>
</html>
